<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher Attendance â€“ Polygon School</title>
<style>
  body { font-family: Arial,sans-serif; background: #f7fbff; margin:0; min-height:100vh; }
  .container { background: #fff; max-width: 650px; margin:32px auto; border-radius:16px; box-shadow:0 1px 16px #0003; padding:30px; }
  .logo-wrap {
    display:flex; justify-content:center; align-items:center; margin-bottom:20px;
  }
  .logo-circle {
    background:#fff;
    border-radius:50%;
    box-shadow:0 2px 8px #00339644;
    width:140px; height:140px;
    display:flex; align-items:center; justify-content:center;
    padding:10px; 
  }
  .logo-circle img { width:120px; height:120px; border-radius:50%; }
  h2,h3 { color: #114c98; text-align: center; margin-top:0; }
  label, select, input { display:block; margin:6px 0; font-size:1rem; }
  button { margin:6px 9px 6px 0; padding:5px 15px; background:#114c98; color:#fff; font-weight:600; border:0; border-radius:5px; cursor:pointer;}
  button:disabled { background:#9bbcec; color:#f9f9f9; cursor:not-allowed;}
  button:hover:enabled { background:#156ddf;}
  table { width:100%; border-collapse:collapse; margin-top:12px;}
  th,td { border:1px solid #dde8f7; padding:7px; text-align:left;}
  th { background:#e7f2fb; color:#184a80;}
  #login, #attendance { display:none; }
  input[type="text"],input[type="password"],input[type="number"] { width:95%;padding:6px; border:1px solid #cee5fc; border-radius:6px;}
</style>
</head>
<body>
<div class="container">
  <div class="logo-wrap">
    <div class="logo-circle">
      <img src="ChatGPT-Image-Oct-30-2025-12_48_35-PM.jpg" alt="Polygon Logo" />
    </div>
  </div>
  <h2>Polygon Senior Secondary School</h2>

  <div id="login">
    <h3>Teacher Login</h3>
    <label>ID: <input id="teacherId" type="text" /></label>
    <label>Password: <input id="teacherPass" type="password" /></label>
    <button onclick="login()">Login</button>
    <p id="loginMessage" style="color:red;"></p>
  </div>

  <div id="attendance">
    <h3>Attendance Panel</h3>
    <label>
      Class:
      <select id="classSelect">
        <option value="">Select Class</option>
        <option value="11">11</option>
        <option value="12">12</option>
      </select>
    </label>
    <label>
      Stream:
      <select id="streamSelect" disabled>
        <option value="">Select Stream</option>
        <option value="Arts">Arts</option>
        <option value="Science">Science</option>
      </select>
    </label>
    <label>
      Section:
      <select id="sectionSelect" disabled>
        <option value="">Select Section</option>
        <option value="A">A</option>
        <option value="B">B</option>
      </select>
    </label>

    <button onclick="loadStudents()">Reload Students</button>

    <h4 style="margin-bottom:4px;color:#156ddf;">Add Student</h4>
    <label>Name: <input id="studentName" type="text" /></label>
    <label>Roll No: <input id="rollNo" type="number" /></label>
    <label>Parent Number: <input id="parentNo" type="text" /></label>
    <button onclick="addStudent()" id="addStudentBtn" disabled>Add Student</button>

    <h4 style="margin-bottom:4px;margin-top:22px;color:#156ddf;">Student List & Attendance</h4>
    <table id="studentTable">
      <thead>
        <tr>
          <th>Roll No</th>
          <th>Name</th>
          <th>Parent Number</th>
          <th>Status</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="submitAttendance()">Submit Attendance</button>
    <p id="attMsg" style="color:green;"></p>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD3C_5CptcWNUJ35E4MzG-fKy7fTjQDCX8",
  authDomain: "polygon-fe569.firebaseapp.com",
  projectId: "polygon-fe569",
  storageBucket: "polygon-fe569.firebasestorage.app",
  messagingSenderId: "75984706919",
  appId: "1:75984706919:web:636bac2ea60839d87423c2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function showLogin() {
  document.getElementById("login").style.display = "block";
  document.getElementById("attendance").style.display = "none";
}

function login() {
  const id = document.getElementById("teacherId").value.trim();
  const pass = document.getElementById("teacherPass").value;
  if(id === "30102025" && pass === "polygon") {
    document.getElementById("login").style.display = "none";
    document.getElementById("attendance").style.display = "block";
  } else {
    document.getElementById("loginMessage").innerText = "Invalid ID or Password";
  }
}

document.getElementById("classSelect").addEventListener("change", function() {
  let cls = this.value;
  let streamSelect = document.getElementById("streamSelect");
  let sectionSelect = document.getElementById("sectionSelect");
  streamSelect.disabled = !cls;
  streamSelect.value = "";
  sectionSelect.disabled = true;
  sectionSelect.value = "";
  clearStudentsTable();
  updateAddButtonState();
});

document.getElementById("streamSelect").addEventListener("change", function() {
  let stream = this.value;
  let sectionSelect = document.getElementById("sectionSelect");
  sectionSelect.disabled = !stream;
  sectionSelect.value = "";
  clearStudentsTable();
  updateAddButtonState();
});

document.getElementById("sectionSelect").addEventListener("change", function() {
  updateAddButtonState();
  loadStudents();
});

function updateAddButtonState() {
  let cls = document.getElementById("classSelect").value.trim();
  let stream = document.getElementById("streamSelect").value.trim();
  let section = document.getElementById("sectionSelect").value.trim();
  document.getElementById("addStudentBtn").disabled = !(cls && stream && section);
}

function getKey() {
  let cls = document.getElementById("classSelect").value.trim();
  let stream = document.getElementById("streamSelect").value.trim();
  let section = document.getElementById("sectionSelect").value.trim();
  return `${cls}-${stream}-${section}`;
}

function clearStudentsTable() {
  document.querySelector("#studentTable tbody").innerHTML = "";
}

async function loadStudents() {
  const key = getKey();
  if (!key || key.includes("undefined") || key.includes("--")) return;
  try {
    const doc = await db.collection("polygonStudents").doc(key).get();
    let students = [];
    if (doc.exists) {
      students = doc.data().students || [];
    }
    updateStudentsTable(students);
    window.studentsData = students;
  } catch (error) {
    console.error("Error loading students:", error);
  }
}

function updateStudentsTable(students) {
  let tbody = document.querySelector("#studentTable tbody");
  tbody.innerHTML = "";
  students.forEach((student, i) => {
    let tr = document.createElement("tr");
    let attBtns = student.status === "Absent"
      ? `<button style="background: #ef3535" disabled>Absent</button>`
      : `<button onclick="markPresent('${student.roll}')">Present</button>
         <button style="background: #ef3535" onclick="markAbsent('${student.roll}')">Absent</button>`;
    tr.innerHTML = `<td>${student.roll}</td>
      <td>${student.name}</td>
      <td>${student.parentNo}</td>
      <td>${attBtns} <span id="status-${student.roll}">${student.status || ""}</span></td>
      <td><button style="background:#e9e9e9;color:#174fa1;" onclick="removeStudent(${i})">X</button></td>`;
    tbody.appendChild(tr);
  });
  window.studentsData = students;
}

async function addStudent() {
  let cls = document.getElementById("classSelect").value.trim();
  let stream = document.getElementById("streamSelect").value.trim();
  let section = document.getElementById("sectionSelect").value.trim();
  if (!(cls && stream && section)) {
    alert("Select Class, Stream and Section first");
    return;
  }
  let name = document.getElementById("studentName").value.trim();
  let roll = document.getElementById("rollNo").value.trim();
  let parentNo = document.getElementById("parentNo").value.trim();
  if (!(name && roll && parentNo)) {
    alert("Please fill all student details");
    return;
  }
  let students = window.studentsData || [];
  if (students.some((s) => s.roll === roll)) {
    alert("Roll Number already exists.");
    return;
  }
  students.push({ name, roll, parentNo, status: "", present: 0, absent: 0 });
  await saveStudents(`${cls}-${stream}-${section}`, students);
  updateStudentsTable(students);
  document.getElementById("studentName").value = "";
  document.getElementById("rollNo").value = "";
  document.getElementById("parentNo").value = "";
}

async function removeStudent(index) {
  let key = getKey();
  let students = window.studentsData || [];
  students.splice(index, 1);
  await saveStudents(key, students);
  updateStudentsTable(students);
}

async function saveStudents(key, students) {
  try {
    await db.collection("polygonStudents").doc(key).set({ students });
    console.log("Saved successfully");
  } catch (error) {
    console.error("Error saving:", error);
  }
}

async function markPresent(roll) {
  let key = getKey();
  let students = window.studentsData || [];
  let student = students.find((s) => s.roll === roll);
  if (student) {
    student.status = "Present";
    if (typeof student.present !== "number") student.present = 0;
    student.present++;
    await saveStudents(key, students);
    updateStudentsTable(students);
  }
}

async function markAbsent(roll) {
  let key = getKey();
  let students = window.studentsData || [];
  let student = students.find((s) => s.roll === roll);
  if (student) {
    student.status = "Absent";
    if (typeof student.absent !== "number") student.absent = 0;
    student.absent++;
    await saveStudents(key, students);
    sendSMS(student);
    updateStudentsTable(students);
  }
}

function sendSMS(student) {
  let date = new Date().toLocaleString();
  alert(`SMS Sent to ${student.parentNo}: ${student.name} was absent on ${date}`);
}

async function submitAttendance() {
  let key = getKey();
  let students = window.studentsData || [];
  if (!students || students.length === 0) {
    alert("No students added for attendance");
    return;
  }
  for (let s of students) {
    if (s.status !== "Present" && s.status !== "Absent") {
      alert(`Mark attendance for roll no ${s.roll}`);
      return;
    }
    s.status = "";
  }
  await saveStudents(key, students);
  updateStudentsTable(students);
  document.getElementById("attMsg").innerText = "Attendance submitted successfully!";
}

window.onload = function () {
  showLogin();
  updateAddButtonState();
};
</script>
</body>
</html>
